<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zyrox AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#111214;
      --panel-2:#15171a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
      --accent:#00C853;
      --accent-2:#00a846;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      display: flex;
      height: 100vh;
      overflow: hidden;
      color: var(--text);
    }

    /* ====== SIDEBAR ====== */
    #sidebar {
      width: 280px;
      background: var(--panel);
      color: var(--text);
      display: flex;
      flex-direction: column;
      padding: 1rem;
      border-right: 1px solid var(--border);
      z-index: 5;
      transition: transform .25s ease, opacity .25s ease;
    }
    #sidebar h1 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 1rem 0;
      color: var(--text);
    }
    #chatList { flex: 1; overflow-y: auto; padding-top: 1rem; }
    .chatItem {
      display: flex; justify-content: space-between; align-items: center;
      background-color: var(--panel-2);
      padding: 0.6rem 0.8rem; margin-bottom: 0.5rem;
      border-radius: 10px; font-size: 0.95rem; cursor: pointer;
      transition: background 0.2s, border 0.2s; border: 1px solid transparent; color: var(--text);
    }
    .chatItem:hover { border-color: var(--border); }
    .deleteBtn { background: none; border: none; color: #f87171; font-size: 1rem; cursor: pointer; margin-left: 0.5rem; }

    /* ====== MAIN ====== */
    #main { flex: 1; display: flex; flex-direction: column; background-color: var(--panel); }

    #topBar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.8rem 1rem; border-bottom: 1px solid var(--border);
      background-color: var(--panel-2); gap: .75rem; flex-wrap: wrap;
    }

    select{
      font-size: 0.95rem; padding: 0.45rem 0.65rem; border-radius: 10px;
      border: 1px solid var(--border); background: #0f1113; color: var(--text); outline: none;
    }

    button{
      padding: 0.6rem 1rem; background-color: var(--accent); color: #061007;
      border: none; border-radius: 10px; font-size: 0.95rem; cursor: pointer;
      transition: transform .05s ease, background .2s ease; font-weight: 600;
    }
    button:hover{ background-color: var(--accent-2); }
    button:active{ transform: translateY(1px); }

    #chatContainer{
      flex: 1; overflow-y: auto; padding: 2rem; background-color: var(--panel);
      display: flex; flex-direction: column;
    }

    .message{
      max-width: 80%; padding: 1rem 1.2rem; margin-bottom: 1rem; border-radius: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25); font-size: 1rem; line-height: 1.5;
      border: 1px solid var(--border); color: var(--text);
      white-space: pre-wrap;
    }
    .user{ align-self: flex-end; background: rgba(0,200,83,0.12); border-color: rgba(0,200,83,0.35); }
    .bot{ align-self: flex-start; background: #0f1113; }

    #welcomeBanner{ text-align: center; color: var(--muted); font-size: 1.2rem; margin-top: 3rem; }

    #newChatBtn{ margin-bottom: 1rem; background-color: var(--accent); color:#061007; }
    #newChatBtn:hover{ background-color: var(--accent-2); }

    /* Files row */
    #fileDisplay{
      display: flex; flex-wrap: nowrap; overflow-x: auto; font-size: 0.75rem;
      padding: 6px 12px; border-top: 1px solid var(--border);
      background-color: #0f1113; color: #d1fae5; align-items: center; gap: 12px;
    }
    .fileBadge{
      background-color: rgba(0,200,83,0.12); border: 1px solid rgba(0,200,83,0.35);
      padding: 2px 6px; border-radius: 8px; white-space: nowrap; display: flex; align-items: center; gap: 6px; color:#a7f3d0;
    }
    .fileBadge button{ all: unset; color:#f87171; cursor: pointer; font-weight: bold; margin-left:4px; }
    .fileBadge span{ font-size: 0.8rem; }

    /* ====== PILL INPUT BAR ====== */
    #inputArea{ border-top: 1px solid var(--border); background-color: var(--panel-2); padding: 1rem; position: relative; }
    .inputPill{
      display: flex; align-items: center; gap: .6rem; background: #0f1113;
      border: 1px solid var(--border); border-radius: 9999px; padding: .5rem .5rem;
    }
    #plusBtn{
      width: 40px; height: 40px; border-radius: 999px; background: transparent; color: var(--text);
      border: 1px solid var(--border); display: grid; place-items: center; font-size: 20px;
    }
    #plusBtn:hover{ border-color: var(--accent); color: var(--accent); background: #0c1110; }
    #imageBtn{
      width: 40px; height: 40px; border-radius: 999px; background: transparent; color: var(--text);
      border: 1px solid var(--border); display: grid; place-items: center; font-size: 18px;
    }
    #imageBtn:hover{ border-color: var(--accent); color: var(--accent); background:#0c1110; }
    textarea{
      flex: 1; resize: none; padding: .9rem 1rem; border-radius: 9999px; font-size: 1rem;
      border: none; outline: none; height: 2.8rem; color: var(--text); background: transparent;
    }
    #sendBtn{
      width: 44px; height: 44px; border-radius: 9999px; display: grid; place-items: center;
      font-size: 18px; padding: 0; color: #061007; background: var(--accent);
    }
    #sendBtn:hover{ background: var(--accent-2); }

    /* Quick actions popover */
    #quickActions{
      position: absolute; bottom: 84px; left: 24px;
      background: #0f1113; border: 1px solid var(--border); border-radius: 12px; padding: .5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35); display: none; min-width: 260px; z-index: 50;
    }
    .qa-item{
      display: flex; align-items: center; gap: .6rem; padding: .6rem .7rem; border-radius: 10px;
      cursor: pointer; color: var(--text); text-decoration: none;
    }
    .qa-item:hover{ background: rgba(255,255,255,0.05); color: var(--accent); }
    .qa-item span.icon{ font-size: 1.1rem; width: 1.4rem; text-align: center; }

    /* ====== MOBILE MODE TOGGLE STYLES ====== */
    #layoutToggle{ background: transparent; border: 1px solid var(--border); color: var(--text); }
    #layoutToggle:hover{ border-color: var(--accent); color: var(--accent); background:#0c1110; }
    #hamburger{
      display: none;
      background: transparent; border: 1px solid var(--border); color: var(--text);
      padding: .5rem .7rem; border-radius: 10px; font-weight: 700;
    }
    #hamburger:hover{ border-color: var(--accent); color: var(--accent); }
    .mobile-mode body { overflow: hidden; }
    .mobile-mode #sidebar{
      position: absolute; left: 0; top: 0; bottom: 0;
      transform: translateX(-100%); opacity: 0;
      width: 84vw; max-width: 360px;
      border-right: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }
    .mobile-mode #main{ flex: 1; }
    .mobile-mode #hamburger{ display: inline-flex; align-items:center; gap:6px; }
    .mobile-mode #sidebarBackdrop{
      position: absolute; inset: 0; background: rgba(0,0,0,0.35);
      display: none; z-index: 4;
    }
    .mobile-mode.sidebar-open #sidebar{ transform: translateX(0); opacity: 1; z-index: 6; }
    .mobile-mode.sidebar-open #sidebarBackdrop{ display: block; }

    /* Image grid inside chat */
    .img-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap: 8px; }
    .img-grid img { width: 100%; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); }
    .muted { color: var(--muted); font-size: 0.9rem; }

    /* Inline image preview in input */
    #imageThumb {
      width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); object-fit: cover;
      display: none;
    }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BT7DVWBW5Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BT7DVWBW5Y');
  </script>
</head>
<body>

<!-- Backdrop for mobile sidebar -->
<div id="sidebarBackdrop"></div>

<div id="sidebar">
  <div style="display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem;">
    <img src="https://i.postimg.cc/Kz82Wdg5/bolt-logo.png" alt="Zyrox Logo" style="height: 36px; width: 36px; border-radius: 6px;" />
    <h1 style="margin: 0; font-size: 1.1rem;">Zyrox</h1>
  </div>

  <button id="newChatBtn" onclick="startNewChat()">+ New Chat</button>
  <div id="chatList"></div>
</div>

<div id="main">
  <div id="topBar">
    <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
      <button id="hamburger" title="Open chats">☰</button>

      <!-- PRIMARY MODE SELECTOR -->
      <select id="modeSelect" onchange="onModeChange()">
        <option value="Instant">Instant – Answers Right Away</option>
        <option value="DeepThink">DeepThink – Thinks Longer For Better Answers</option>
        <option value="Specialized">Specialized Models</option>
      </select>

      <!-- SECONDARY: appears only for Specialized -->
      <select id="specializedSelect" style="display:none;" onchange="setModelFromSpecialized()">
        <option value="Zyrox O4 Nexus">Zyrox O4 Nexus – Everyday Assistant</option>
        <option value="Zyrox O5 Forge">Zyrox O5 Forge – Coding Expert</option>
        <option value="Zyrox O6 Vita">Zyrox O6 Vita – Health & Wellness Specialist</option>
        <option value="Zyrox O7 Quill">Zyrox O7 Quill – Writing Assistant</option>
        <option value="Zyrox O8 Polyglot">Zyrox O8 Polyglot – Elite Translation Companion</option>
        <option value="Zyrox O9 Ledger">Zyrox O9 Ledger – Finance & Management Guru</option>
      </select>
    </div>

    <!-- Web Search Controls -->
    <div style="display:flex; gap:.5rem; align-items:center; flex-wrap: wrap;">
      <label style="display:flex; align-items:center; gap:.4rem; cursor:pointer;">
        <input type="checkbox" id="webToggle" />
        <span>Use Web Search</span>
      </label>
      <select id="webMode">
        <option value="web">Web</option>
        <option value="news">News</option>
        <option value="images">Images</option>
      </select>
      <select id="webRecency" title="Recency">
        <option value="">Any time</option>
        <option value="d">Past day</option>
        <option value="w">Past week</option>
        <option value="m">Past month</option>
        <option value="y">Past year</option>
      </select>
      <button id="layoutToggle" title="Toggle Desktop/Mobile">Toggle Layout</button>
    </div>
  </div>

  <div id="chatContainer"></div>
  <div id="fileDisplay"></div>

  <div id="inputArea">
    <div class="inputPill">
      <button id="plusBtn" title="Quick actions">+</button>

      <!-- Image attach -->
      <button id="imageBtn" title="Attach image">Upload Image</button>
      <input id="imageInput" type="file" accept="image/*" style="display:none">
      <img id="imageThumb" alt="preview">

      <textarea id="userInput" placeholder="Type your question here..."></textarea>
      <button id="sendBtn" onclick="sendMessage()" title="Send">↑</button>
    </div>
    <!-- Quick actions popover -->
    <div id="quickActions">
      <a class="qa-item" href="https://932f549d6329f527a5.gradio.live/" target="_blank" rel="noopener">
        <span class="icon">📷</span> Image generator
      </a>
      <a class="qa-item" href="https://forms.office.com/r/33SKdMEZ03" target="_blank" rel="noopener">
        <span class="icon">💡</span> Suggest a Feature
      </a>
      <div class="qa-item" onclick="uploadFile()">
        <span class="icon">📎</span> Upload files (PDF)
      </div>
      <a class="qa-item" href="https://github.com/IsherCoder/bolt/raw/main/terms%20and%20conditions.pdf" target="_blank" rel="noopener">
        <span class="icon">📄</span> Terms & Conditions
      </a>
    </div>
  </div>
</div>

<script>
  /* ====== State ====== */
  const chatContainer = document.getElementById('chatContainer');
  const input = document.getElementById('userInput');
  const chatList = document.getElementById('chatList');

  const webToggle = document.getElementById('webToggle');
  const webModeSel = document.getElementById('webMode');
  const webRecencySel = document.getElementById('webRecency');

  const modeSelect = document.getElementById('modeSelect');
  const specializedSelect = document.getElementById('specializedSelect');

  // Image attach UI state
  const imageBtn = document.getElementById('imageBtn');
  const imageInput = document.getElementById('imageInput');
  const imageThumb = document.getElementById('imageThumb');
  let pendingImageFile = null;
  let pendingImagePreviewUrl = null;

  function escapeHtml(s){
    return (s || "").replace(/[&<>\"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  imageBtn.addEventListener('click', () => imageInput.click());
  imageInput.addEventListener('change', () => {
    const f = imageInput.files[0];
    if (f) {
      pendingImageFile = f;
      if (pendingImagePreviewUrl) URL.revokeObjectURL(pendingImagePreviewUrl);
      pendingImagePreviewUrl = URL.createObjectURL(f);
      imageThumb.src = pendingImagePreviewUrl;
      imageThumb.style.display = 'block';
    }
  });

  let chatHistory = [];
  // Persist selections
  const savedMode = localStorage.getItem("zyroxMode") || "Instant";
  const savedSpecialized = localStorage.getItem("zyroxSpecialized") || "Zyrox O4 Nexus";
  modeSelect.value = savedMode;
  specializedSelect.value = savedSpecialized;
  if (savedMode === "Specialized") specializedSelect.style.display = "inline-block";

  // Current effective “model label” sent to backend:
  let selectedModel = savedMode === "Specialized" ? savedSpecialized : savedMode;

  const modelWelcomeMessages = {
    "Instant": "⚡ Instant mode: short, direct answers. Ask away.",
    "DeepThink": "🧠 DeepThink mode: thorough, detailed reasoning.",
    "Zyrox O4 Nexus": "👋 I’m Zyrox O4 Nexus – your everyday assistant.",
    "Zyrox O5 Forge": "🧑‍💻 I’m Zyrox O5 Forge – your coding wizard.",
    "Zyrox O6 Vita": "💪 I’m Zyrox O6 Vita – health & wellness support.",
    "Zyrox O7 Quill": "✍️ I’m Zyrox O7 Quill – your writing expert.",
    "Zyrox O8 Polyglot": "🌍 I’m Zyrox O8 Polyglot – elite translation.",
    "Zyrox O9 Ledger": "💼 I’m Zyrox O9 Ledger – finance & management."
  };

  function onModeChange() {
    const mode = modeSelect.value;
    localStorage.setItem("zyroxMode", mode);

    if (mode === "Specialized") {
      specializedSelect.style.display = "inline-block";
      selectedModel = specializedSelect.value;
    } else {
      specializedSelect.style.display = "none";
      selectedModel = mode; // "Instant" or "DeepThink"
    }
    localStorage.setItem("selectedModel", selectedModel);
    renderChat();
  }

  function setModelFromSpecialized() {
    const val = specializedSelect.value;
    localStorage.setItem("zyroxSpecialized", val);
    selectedModel = val;
    localStorage.setItem("selectedModel", selectedModel);
    renderChat();
  }

  function saveChat() {
    const allChats = JSON.parse(localStorage.getItem("boltChats") || "{}");
    allChats[currentChatId] = chatHistory;
    localStorage.setItem("boltChats", JSON.stringify(allChats));
    loadChatList();
  }

  function loadChatList() {
    chatList.innerHTML = "";
    const allChats = JSON.parse(localStorage.getItem("boltChats") || "{}");
    Object.keys(allChats).forEach(id => {
      const firstMsg = allChats[id].find(m => m.role === "user");
      const title = firstMsg
        ? (typeof firstMsg.content === "string"
            ? firstMsg.content.slice(0,30)
            : (firstMsg.content?.text || "Untitled")).slice(0,30) + "..."
        : "Untitled Chat";

      const div = document.createElement("div");
      div.className = "chatItem";

      const titleSpan = document.createElement("span");
      titleSpan.textContent = title;
      titleSpan.style.flex = "1";
      titleSpan.onclick = () => { loadChat(id); if (document.body.classList.contains('mobile-mode')) closeSidebarMobile(); };

      const delBtn = document.createElement("button");
      delBtn.className = "deleteBtn";
      delBtn.innerHTML = "🗑️";
      delBtn.onclick = (e) => {
        e.stopPropagation();
        deleteChat(id);
      };

      div.appendChild(titleSpan);
      div.appendChild(delBtn);
      chatList.appendChild(div);
    });
  }

  function deleteChat(id) {
    const allChats = JSON.parse(localStorage.getItem("boltChats") || "{}");
    delete allChats[id];
    localStorage.setItem("boltChats", JSON.stringify(allChats));

    const files = JSON.parse(localStorage.getItem("boltFiles") || "{}");
    delete files[id];
    localStorage.setItem("boltFiles", JSON.stringify(files));

    if (currentChatId === id) {
      chatHistory = [];
      currentChatId = null;
      renderChat();
    }

    loadChatList();
  }

  function loadChat(id) {
    currentChatId = id;
    chatHistory = JSON.parse(localStorage.getItem("boltChats"))[id];
    renderChat();
  }

  let currentChatId = null;
  function startNewChat() {
    chatHistory = [];
    currentChatId = Date.now().toString();
    renderChat();
  }

  function renderChat() {
    chatContainer.innerHTML = "";
    if (!chatHistory.length) {
      const welcome = modelWelcomeMessages[selectedModel] || "👋 Hello, I’m Zyrox. How can I help you today?";
      chatContainer.innerHTML = `<div id="welcomeBanner">${welcome}<br><br>Click “+ New Chat” to begin.</div>`;
    }
    chatHistory.forEach(msg => {
      renderBubble(msg.role, msg.content, msg.type);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
    renderFiles();
  }

  function renderBubble(role, content, type) {
    const bubble = document.createElement("div");
    bubble.className = "message " + (role === "user" ? "user" : "bot");

    if (type === "images" && Array.isArray(content)) {
      bubble.innerHTML = `<div class="muted">🔎 Image results</div>`;
      const grid = document.createElement("div");
      grid.className = "img-grid";
      content.forEach(obj => {
        const a = document.createElement("a");
        a.href = obj.image || obj.url || obj.thumbnail;
        a.target = "_blank";
        const img = document.createElement("img");
        img.src = obj.thumbnail || obj.image || "";
        img.alt = obj.title || "image";
        a.appendChild(img);
        grid.appendChild(a);
      });
      bubble.appendChild(grid);
    } else if (type === "imageUpload" && content && content.previewUrl) {
      bubble.innerHTML =
        `<div>${escapeHtml(content.text || "")}</div>` +
        `<div style="margin-top:8px;"><img src="${content.previewUrl}" style="max-width:240px; border-radius:10px; border:1px solid var(--border)"></div>`;
    } else {
      bubble.textContent = content;
    }
    chatContainer.appendChild(bubble);
  }

  function renderFiles() {
    const allFiles = JSON.parse(localStorage.getItem("boltFiles") || "{}");
    const files = allFiles[currentChatId] || [];
    const display = document.getElementById("fileDisplay");
    display.innerHTML = "";

    files.forEach((f, index) => {
      const badge = document.createElement("div");
      badge.className = "fileBadge";
      badge.innerHTML = `📄 ${f} <span>✅</span> <button onclick="removeFile(${index})">✖</button>`;
      display.appendChild(badge);
    });
  }

  function removeFile(index) {
    const allFiles = JSON.parse(localStorage.getItem("boltFiles") || "{}");
    if (!allFiles[currentChatId]) return;
    allFiles[currentChatId].splice(index, 1);
    localStorage.setItem("boltFiles", JSON.stringify(allFiles));
    renderFiles();
  }

  async function duckSearch(q, mode="web", timelimit="") {
    const body = { q, mode, summarize: mode !== "images", max_results: 8, region: "uk-en", safesearch: "moderate" };
    if (timelimit) body.timelimit = timelimit;
    const res = await fetch("/web_search", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error("Search failed");
    return res.json();
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text && !pendingImageFile) return;

    // Show the user's bubble
    if (pendingImageFile) {
      // One combined bubble with text + image preview
      chatHistory.push({ role: "user", type: "imageUpload", content: { text, previewUrl: pendingImagePreviewUrl } });
    } else {
      chatHistory.push({ role: "user", content: text });
    }
    input.value = "";
    renderChat();

    // Bot streaming placeholder
    const botMsg = { role: "assistant", content: "" };
    chatHistory.push(botMsg);
    const bubble = document.createElement("div");
    bubble.className = "message bot";
    chatContainer.appendChild(bubble);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    // Optional: web search
    let web_summary_for_model = "";
    if (webToggle.checked) {
      try {
        const mode = webModeSel.value;
        const timelimit = webRecencySel.value;
        const data = await duckSearch(text, mode, timelimit);

        if (mode === "images") {
          chatHistory.push({ role: "assistant", content: data.results, type: "images" });
          renderBubble("assistant", data.results, "images");
        } else {
          const summary = data.answer || "(No summary)";
          const summaryBubble = `🔎 Web summary (${mode})\n\n${summary}`;
          chatHistory.push({ role: "assistant", content: summaryBubble });
          renderBubble("assistant", summaryBubble);
          web_summary_for_model = summary;
        }
      } catch (e) {
        const err = `⚠️ Web search failed: ${e.message || e}`;
        chatHistory.push({ role: "assistant", content: err });
        renderBubble("assistant", err);
      }
    }

    const payloadSelected = selectedModel;

    // Build request (JSON or multipart if image attached)
    let res;
    if (pendingImageFile) {
      const fd = new FormData();
      fd.append("history", JSON.stringify(chatHistory));
      fd.append("selected_model", payloadSelected);
      fd.append("web_summary", web_summary_for_model);
      fd.append("user_text", text || "What's in this image?");
      fd.append("image", pendingImageFile);
      res = await fetch("/chat", { method: "POST", body: fd });
    } else {
      res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          history: chatHistory,
          selected_model: payloadSelected,
          web_summary: web_summary_for_model
        })
      });
    }

    // Stream response
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let fullText = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value);
      fullText += chunk;
      bubble.textContent = fullText;
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    botMsg.content = fullText;
    saveChat();

    // Reset image attach UI
    if (pendingImagePreviewUrl) URL.revokeObjectURL(pendingImagePreviewUrl);
    pendingImageFile = null;
    pendingImagePreviewUrl = null;
    imageThumb.src = "";
    imageThumb.style.display = "none";
    imageInput.value = "";
  }

  function uploadFile() {
    const file = document.createElement('input');
    file.type = 'file';
    file.accept = '.pdf,.docx';
    file.onchange = async () => {
      const selected = file.files[0];
      if (!selected) return;

      const formData = new FormData();
      formData.append("file", selected);

      const res = await fetch("/upload", { method: "POST", body: formData });
      const data = await res.json();
      if (data.extracted_text) {
        alert("📄 File uploaded and processed!");
        const allFiles = JSON.parse(localStorage.getItem("boltFiles") || "{}");
        if (!allFiles[currentChatId]) allFiles[currentChatId] = [];
        allFiles[currentChatId].push(selected.name);
        localStorage.setItem("boltFiles", JSON.stringify(allFiles));
        localStorage.setItem("boltCustomContext", data.extracted_text);
        renderFiles();
      } else {
        alert("❌ Error: " + (data.error || "Unable to extract file."));
      }
    };
    file.click();
  }

  // Enter to send
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Quick actions popover toggle
  const plusBtn = document.getElementById('plusBtn');
  const quick = document.getElementById('quickActions');
  plusBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    quick.style.display = quick.style.display === 'block' ? 'none' : 'block';
  });
  document.addEventListener('click', ()=>{ quick.style.display = 'none'; });

  /* ====== Layout & Mobile Sidebar Toggles ====== */
  const layoutToggle = document.getElementById('layoutToggle');
  const hamburger = document.getElementById('hamburger');
  const sidebarBackdrop = document.getElementById('sidebarBackdrop');

  const savedLayout = localStorage.getItem('boltLayout') || 'desktop';
  if (savedLayout === 'mobile') enableMobileMode(); else enableDesktopMode();

  layoutToggle.addEventListener('click', ()=>{
    if (document.body.classList.contains('mobile-mode')) {
      enableDesktopMode();
    } else {
      enableMobileMode();
    }
  });

  hamburger.addEventListener('click', ()=>{
    if (!document.body.classList.contains('mobile-mode')) return;
    document.body.classList.toggle('sidebar-open');
  });
  sidebarBackdrop.addEventListener('click', closeSidebarMobile);

  function enableMobileMode(){
    document.body.classList.add('mobile-mode');
    document.body.classList.remove('sidebar-open');
    layoutToggle.textContent = 'Switch to Desktop';
    localStorage.setItem('boltLayout','mobile');
  }
  function enableDesktopMode(){
    document.body.classList.remove('mobile-mode');
    document.body.classList.remove('sidebar-open');
    layoutToggle.textContent = 'Switch to Mobile';
    localStorage.setItem('boltLayout','desktop');
  }
  function closeSidebarMobile(){ document.body.classList.remove('sidebar-open'); }

  loadChatList();
  renderChat();
</script>
</body>
</html>
